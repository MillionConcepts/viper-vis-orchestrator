{% extends "layouts/wrapper.html" %}
{% load static %}
{% block content %}
<div id="content-div">
    {% if form.req_id is not None %}
        <h2>editing image request {{ form.req_id }}</h2>
        {% if form.product_ids|length > 0 %}
            <h4>associated products:
            {% for product_id in form.product_ids %}<a href="{{ product_id }}">{{ product_id }}</a> {% endfor %}
            </h4>
        {% endif %}
    {% else %}
        <h2>new image request</h2>
    {% endif %}
    {% if form.errors %}
        {{ form.errors }}
    {% endif %}
    {% if form.product_ids|length > 0 %}
        <div id='multiple-eval-container' class="multiple-form-container" style="display: flex">
        {# empty forms that provide hooks for input elements in eval-table rows #}
        {% for hyp in form.ldst_hypotheses %}
            <form id="{{ hyp }}-eval-form"
                  class="eval-form"
                  method="POST"
                  enctype="multipart/form-data"
                  action="/submitevaluation?req_id={{ form.req_id }}&hyp={{ hyp }}">
            </form>
        {% endfor %}
        </div>
        <button id="evaluation-toggle" onClick="toggleEvalTable()"></button>
        <table id="eval-table" class="eval-table"
           {% if eval_ui_status %}
           style="display: inherit"
           {% else %}
           style="display: none"
           {% endif %}>
            <thead>
            <tr><th>hypothesis</th><th>supports?</th><th>notes</th><th>evaluator</th><th>submit</th></tr>
            </thead>
            <tbody id="eval-table-body">
            {% for hyp in form.ldst_hypotheses %}
                <tr id="{{ hyp }}-eval-row" class="eval-input-row"></tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}
    <form method="POST" action="/submitrequest?req_id={{ form.req_id }}" enctype="multipart/form-data">
        <div id="form-panel" class="split-flow-container request-container">
        <div class="vertical-form-inner">
            <div id="selective-status-hider"
             {# for new requests, status is always "WORKING" #}
             {% if form.req_id is None %}style="display: none"{% endif %}>
                <label for={{ form.status.id }}>{{ form.status.label}}</label>
                {{ form.status }}
            </div>
        {% for field in form %}
        {% if field.name == 'justification' or field.name == 'title' %}
            <div id="{{ field.name }}-field-div" class="{{ field.widget_type }}-field vertical-form-field">
            <label for="{{ field.id }}">{{ field.label }}</label>
            {{ field }}
            </div>
        {% endif %}
        {% endfor %}
        {% for field in form %}
        {% if field.name == 'status' or field.name == 'justification' or field.name == 'title' %}
        {% else %}
        <div id="{{ field.name }}-field-div"
             class="{{ field.widget_type }}-field vertical-form-field">
            <label
                {% if field.name in form.slice_fields %}class="pano-only slice-field"
                {% elif field.name in form.pano_only_fields %}class="pano-only"
                {% endif %}
                for="{{ field.id }}">{{ field.label }}
                {% if field.name == 'supplementary_file' and filename is not None %}
                    (existing file:
                    <a href="{{ file_url }}">{{ filename }})</a>)
                {% endif %}
            </label>
            {{field}}
        </div>
        {% endif %}
        {% endfor %}
        <div>
            <button type="submit" name="submitrequest">submit request</button>
        </div>
        </div>
        {# populated by js #}
        <div id="ldst-field-div" class="vertical-form-field two-column-checkbox">
            <label style="margin-bottom: 1rem; margin-top: 0.5rem">ldst hypotheses</label>
        </div>
        </div>
    </form>
</div>
<div id="hidden-info" style="display: none">
    <p id="eval_error_json">{{ eval_ui_status.errors }}</p>
    <p id="eval_json" style="display:none">{{ eval_json }}</p>
</div>

{% endblock %}
{% block localscripts %}
<script>
    const reqID = "{{ form.req_id }}"
    const evalUIHyp = "{{ eval_ui_status.hyp }}"
</script>
<script src="{% static 'js/imagerequest.js' %}"></script>
{% endblock %}
